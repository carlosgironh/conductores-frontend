<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ingreso Usuario / Recuperar Clave</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{ font-family:Arial; background:#eef2f7; padding:20px; }
.card{ background:white; padding:20px; border-radius:12px; max-width:500px; margin:auto; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
input,textarea,button{ width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box;}
button{ font-weight:bold; border:none; cursor:pointer; }
.login{ background:#0d6efd; color:white; }
.recuperar{ background:#ffc107; color:white; }
.reset{ background:#198754; color:white; }
.msg{ margin-top:10px; font-weight:bold; text-align:center; }
.hidden{ display:none; }
.valid{ border:2px solid #198754; }
.invalid{ border:2px solid #dc3545; }
</style>
</head>
<body>

<!-- ============================= -->
<!-- TARJETA LOGIN -->
<!-- ============================= -->
<div class="card" id="loginCard">
<h2>Ingreso Usuario</h2>

<input id="usuario" placeholder="Correo o c√©dula">
<input type="password" id="password" placeholder="Contrase√±a">

<!-- Honeypot anti-bots (campo invisible) -->
<input type="text" id="website" style="display:none">

<button class="login" onclick="login()">Ingresar</button>
<button class="recuperar" onclick="recuperarPassword()">Olvid√© mi contrase√±a</button>
<div id="loginMsg" class="msg"></div>
</div>

<!-- ============================= -->
<!-- TARJETA RESET PASSWORD -->
<!-- ============================= -->
<div class="card hidden" id="resetCard">
<h2>Restablecer Contrase√±a</h2>

<input type="password" id="newPassword" placeholder="Nueva contrase√±a (m√≠nimo 6 caracteres)">
<input type="password" id="confirmPassword" placeholder="Confirmar nueva contrase√±a">

<button class="reset" onclick="resetPassword()">Cambiar Contrase√±a</button>
<div id="resetMsg" class="msg"></div>
</div>

<script>
const API = "https://conductores-api.onrender.com";
let formLoadTime = Date.now(); // Para validar tiempo humano

// ==================================================
// VALIDACI√ìN EN TIEMPO REAL
// ==================================================
usuario.addEventListener("input", () => {
  const val = usuario.value.trim();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if(emailRegex.test(val) || val.length >= 6){
    usuario.classList.add("valid");
    usuario.classList.remove("invalid");
  } else {
    usuario.classList.add("invalid");
    usuario.classList.remove("valid");
  }
});

password.addEventListener("input", () => {
  if(password.value.length >= 6){
    password.classList.add("valid");
    password.classList.remove("invalid");
  } else {
    password.classList.add("invalid");
    password.classList.remove("valid");
  }
});

// ==================================================
// LOGIN USUARIO
// ==================================================
async function login(){

  // üõ°Ô∏è Protecci√≥n anti-bot (honeypot)
  if(document.getElementById("website").value !== "") return;

  // üõ°Ô∏è Protecci√≥n anti-bot (env√≠o demasiado r√°pido)
  if(Date.now() - formLoadTime < 1500){
    loginMsg.innerText="Espera un momento antes de enviar ‚ùå";
    return;
  }

  const usuarioVal = usuario.value.trim();
  const passwordVal = password.value.trim();

  if(!usuarioVal || !passwordVal){
    loginMsg.innerText="Completa todos los campos ‚ùå";
    return;
  }

  loginMsg.innerText="Verificando...";

  try{
    const res = await fetch(`${API}/api/login-usuario`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ usuario: usuarioVal, password: passwordVal })
    });

    const text = await res.text();

    if(!res.ok){
      loginMsg.innerText="Usuario o clave incorrecta ‚ùå";
      return;
    }

    const data = JSON.parse(text);

    localStorage.setItem("userToken", data.token);

    loginMsg.innerText="Ingreso exitoso ‚úÖ";

    setTimeout(()=> 
      window.location.href="perfil.html?token="+data.qr_token
    ,800);

  }catch(err){
    console.error(err);
    loginMsg.innerText="Error conectando con servidor ‚ùå";
  }
}

// ==================================================
// RECUPERAR CONTRASE√ëA
// ==================================================
async function recuperarPassword(){

  const input = prompt("Ingresa tu correo o c√©dula:");
  if(!input) return;

  loginMsg.innerText="Solicitando recuperaci√≥n...";

  try{
    const res = await fetch(`${API}/api/admin/recuperar-password`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ usuario: input.trim() })
    });

    const text = await res.text();

    if(res.ok){
      loginMsg.innerText="Si el usuario existe, se envi√≥ enlace temporal ‚úÖ";
    }else{
      try{
        const err = JSON.parse(text);
        loginMsg.innerText=`Error: ${err.message || 'Solicitud inv√°lida'} ‚ùå`;
      }catch{
        loginMsg.innerText="Error inesperado del servidor ‚ùå";
        console.error(text);
      }
    }

  }catch(err){
    console.error(err);
    loginMsg.innerText="Error conectando con servidor ‚ùå";
  }
}

// ==================================================
// DETECTAR TOKEN EN URL
// ==================================================
const params = new URLSearchParams(window.location.search);
const resetToken = params.get("reset_token");

if(resetToken){
  loginCard.classList.add("hidden");
  resetCard.classList.remove("hidden");
}

// ==================================================
// RESET PASSWORD
// ==================================================
async function resetPassword(){

  const newPass = newPassword.value.trim();
  const confirmPass = confirmPassword.value.trim();

  if(newPass.length < 6){
    resetMsg.innerText="M√≠nimo 6 caracteres ‚ùå";
    return;
  }

  if(newPass !== confirmPass){
    resetMsg.innerText="Las contrase√±as no coinciden ‚ùå";
    return;
  }

  resetMsg.innerText="Actualizando contrase√±a...";

  try{
    const res = await fetch(`${API}/api/usuario/reset-password`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ token: resetToken, new_password: newPass })
    });

    const text = await res.text();

    if(res.ok){
      resetMsg.innerText="Contrase√±a actualizada ‚úÖ";
      setTimeout(()=> window.location.href="dashboard.html",1500);
    }else{
      try{
        const err = JSON.parse(text);
        resetMsg.innerText=`Error: ${err.message || 'No se pudo actualizar'} ‚ùå`;
      }catch{
        resetMsg.innerText="Error inesperado del servidor ‚ùå";
        console.error(text);
      }
    }

  }catch(err){
    console.error(err);
    resetMsg.innerText="Error conectando con servidor ‚ùå";
  }
}
</script>

</body>
</html>