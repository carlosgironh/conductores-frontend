<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrativo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{ font-family:Arial; background:#eef2f7; padding:20px; }
.card{ background:white; padding:20px; border-radius:12px; max-width:700px; margin:auto; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
input,textarea,button{ width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc; }
button{ font-weight:bold; border:none; cursor:pointer; }
.login{ background:#0d6efd; color:white; }
.buscar{ background:#198754; color:white; }
.guardar{ background:#dc3545; color:white; }
.logout{ background:#6c757d; color:white; }
.olvidar{ background:#ffc107; color:white; }
.hidden{ display:none; }
.msg{ margin-top:10px; font-weight:bold; text-align:center; }
.conductorCard{ background:#f8f9fa; padding:10px; border-radius:6px; margin-top:10px; }
</style>
</head>
<body>

<div class="card" id="loginCard">
<h2>Ingreso Administrador</h2>
<input id="usuario" placeholder="Usuario">
<input type="password" id="password" placeholder="Contraseña">
<button class="login" onclick="login()">Ingresar</button>
<button class="olvidar" onclick="recuperarPassword()">Olvidé mi contraseña</button>
<div id="loginMsg" class="msg"></div>
</div>

<div class="card hidden" id="adminPanel">
<h2>Panel Administrativo de Conductores</h2>

<input id="buscarCedula" placeholder="Buscar por cédula">
<button class="buscar" onclick="buscar()">Buscar</button>

<div id="info"></div>

<textarea id="descripcion" placeholder="Nuevo reporte"></textarea>
<button class="guardar" onclick="guardar()">Guardar Reporte</button>
<button class="logout" onclick="logout()">Cerrar Sesión</button>
<div id="msg" class="msg"></div>
</div>

<script>
const API = "https://conductores-api.onrender.com";
let token = localStorage.getItem("adminToken");
let conductorActual = null;

if(token) mostrarPanel();

// ---------------------------
// LOGIN ADMIN
// ---------------------------
async function login(){
  loginMsg.innerText = "Verificando...";
  try{
    const res = await fetch(`${API}/api/admin/login`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ usuario: usuario.value, password: password.value })
    });
    if(!res.ok){ loginMsg.innerText="Credenciales incorrectas ❌"; return; }
    const data = await res.json();
    token = data.token;
    localStorage.setItem("adminToken", token);
    mostrarPanel();
  }catch{ loginMsg.innerText="Error conectando con servidor ❌"; }
}

// ---------------------------
// MOSTRAR PANEL
// ---------------------------
function mostrarPanel(){
  loginCard.classList.add("hidden");
  adminPanel.classList.remove("hidden");
}

// ---------------------------
// CERRAR SESIÓN
// ---------------------------
function logout(){
  localStorage.removeItem("adminToken");
  location.reload();
}

// ---------------------------
// BUSCAR CONDUCTOR
// ---------------------------
async function buscar(){
  info.innerHTML = "Buscando...";
  try{
    const res = await fetch(`${API}/api/admin/conductores?q=${buscarCedula.value}`,{
      headers:{ "Authorization":"Bearer "+token }
    });
    if(!res.ok) throw new Error();
    const data = await res.json();
    if(data.length===0){ info.innerHTML="No encontrado"; conductorActual=null; return; }
    conductorActual = data[0];
    info.innerHTML = `
      <div class="conductorCard">
        <strong>${conductorActual.nombres} ${conductorActual.apellidos}</strong><br>
        Cédula: ${conductorActual.cedula}<br>
        Estado: ${conductorActual.estado || 'N/A'}<br>
        <a href="conductor.html?id=${conductorActual.id}" target="_blank">Ver Perfil Completo</a>
      </div>
    `;
  }catch{ info.innerHTML="Error buscando ❌"; }
}

// ---------------------------
// GUARDAR QUEJA
// ---------------------------
async function guardar(){
  if(!conductorActual) return alert("Primero busca un conductor");
  const descripcion = descripcion.value;
  if(!descripcion) return alert("Escribe un reporte");
  try{
    const res = await fetch(`${API}/api/quejas`,{
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
      body: JSON.stringify({ conductor_id: conductorActual.id, descripcion })
    });
    msg.innerText = res.ok ? "Reporte guardado ✅" : "Error guardando ❌";
    descripcion.value="";
  }catch{ msg.innerText="Error ❌"; }
}

// ---------------------------
// RECUPERAR CONTRASEÑA
// ---------------------------
async function recuperarPassword(){
  const email = prompt("Ingresa tu correo de administrador para reiniciar la contraseña:");
  if(!email) return;
  loginMsg.innerText = "Solicitando recuperación de contraseña...";
  try{
    const res = await fetch(`${API}/api/admin/recuperar-password`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });
    if(res.ok){
      loginMsg.innerText = "Correo enviado ✅ Revisa tu bandeja de entrada.";
    } else {
      const err = await res.json();
      loginMsg.innerText = `Error: ${err.message || 'No se pudo enviar correo'} ❌`;
    }
  }catch(err){
    console.error(err);
    loginMsg.innerText = "Error conectando con servidor ❌";
  }
}
</script>

</body>
</html>