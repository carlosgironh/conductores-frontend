<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ingreso Usuario / Recuperar Clave</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{ font-family:Arial; background:#eef2f7; padding:20px; }
.card{ background:white; padding:20px; border-radius:12px; max-width:500px; margin:auto; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
input,textarea,button{ width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box;}
button{ font-weight:bold; border:none; cursor:pointer; }
.login{ background:#0d6efd; color:white; }
.recuperar{ background:#ffc107; color:white; }
.reset{ background:#198754; color:white; }
.msg{ margin-top:10px; font-weight:bold; text-align:center; }
.hidden{ display:none; }
</style>
</head>
<body>

<div class="card" id="loginCard">
<h2>Ingreso Usuario</h2>
<input id="usuario" placeholder="Correo o cédula">
<input type="password" id="password" placeholder="Contraseña">
<button class="login" onclick="login()">Ingresar</button>
<button class="recuperar" onclick="recuperarPassword()">Olvidé mi contraseña</button>
<div id="loginMsg" class="msg"></div>
</div>

<div class="card hidden" id="resetCard">
<h2>Restablecer Contraseña</h2>
<input type="password" id="newPassword" placeholder="Nueva contraseña (mínimo 6 caracteres)">
<input type="password" id="confirmPassword" placeholder="Confirmar nueva contraseña">
<button class="reset" onclick="resetPassword()">Cambiar Contraseña</button>
<div id="resetMsg" class="msg"></div>
</div>

<script>
const API = "https://conductores-api.onrender.com";

// ---------------------------
// LOGIN USUARIO
// ---------------------------
async function login(){
  const usuarioVal = usuario.value.trim();
  const passwordVal = password.value.trim();
  if(!usuarioVal || !passwordVal){ loginMsg.innerText="Completa todos los campos ❌"; return; }

  loginMsg.innerText = "Verificando...";
  try{
    const res = await fetch(`${API}/api/login-usuario`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ usuario: usuarioVal, password: passwordVal })
    });
    if(!res.ok){ loginMsg.innerText="Usuario o clave incorrecta ❌"; return; }

    const data = await res.json();
    localStorage.setItem("userToken", data.token);
    loginMsg.innerText="Ingreso exitoso ✅";
    setTimeout(()=> window.location.href="perfil.html?token="+data.qr_token,800);
  }catch(err){
    console.error(err);
    loginMsg.innerText="Error conectando con servidor ❌";
  }
}

// ---------------------------
// RECUPERAR CONTRASEÑA
// ---------------------------
async function recuperarPassword(){
  const input = prompt("Ingresa tu correo o cédula para recibir un enlace temporal:");
  if(!input) return;
  loginMsg.innerText = "Solicitando recuperación...";

  try{
    const res = await fetch(`${API}/api/admin/recuperar-password`,{ // <- usa endpoint que exista
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ usuario: input })
    });

    const text = await res.text(); // leer respuesta
    if(res.ok){
      loginMsg.innerText = "Se envió un enlace temporal a tu correo registrado ✅";
    } else {
      try{
        const err = JSON.parse(text);
        loginMsg.innerText = `Error: ${err.message || 'No se pudo enviar el enlace'} ❌`;
      }catch{
        loginMsg.innerText = "Error: respuesta inesperada del servidor ❌";
        console.error("Respuesta inválida:", text);
      }
    }
  }catch(err){
    console.error(err);
    loginMsg.innerText="Error conectando con servidor ❌";
  }
}

// ---------------------------
// CAMBIO DE CONTRASEÑA CON TOKEN
// ---------------------------
const params = new URLSearchParams(window.location.search);
const resetToken = params.get("reset_token");

if(resetToken){
  loginCard.classList.add("hidden");
  resetCard.classList.remove("hidden");
}

async function resetPassword(){
  const newPass = newPassword.value.trim();
  const confirmPass = confirmPassword.value.trim();

  if(newPass.length < 6){ resetMsg.innerText="La contraseña debe tener mínimo 6 caracteres ❌"; return; }
  if(newPass !== confirmPass){ resetMsg.innerText="Las contraseñas no coinciden ❌"; return; }

  resetMsg.innerText = "Restableciendo contraseña...";
  try{
    const res = await fetch(`${API}/api/usuario/reset-password`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ token: resetToken, new_password: newPass })
    });

    const text = await res.text();
    if(res.ok){
      resetMsg.innerText="Contraseña cambiada ✅ Redirigiendo...";
      setTimeout(()=> window.location.href="dashboard.html",1500);
    } else {
      try{
        const err = JSON.parse(text);
        resetMsg.innerText = `Error: ${err.message || 'No se pudo cambiar la contraseña'} ❌`;
      }catch{
        resetMsg.innerText = "Error: respuesta inesperada del servidor ❌";
        console.error("Respuesta inválida:", text);
      }
    }

  }catch(err){
    console.error(err);
    resetMsg.innerText="Error conectando con servidor ❌";
  }
}
</script>

</body>
</html>