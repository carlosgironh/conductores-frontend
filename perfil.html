<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Perfil del Conductor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<div class="card">
  <h2>Perfil del Conductor</h2>
  <div id="contenido">Cargando...</div>
  <div style="text-align:center;margin-top:25px;">
    <canvas id="qr"></canvas><br>
    <button onclick="descargarQR()">Descargar QR</button>
  </div>
</div>

<script>
const API = "https://conductores-api.onrender.com";
const qr_token = new URLSearchParams(window.location.search).get("token");

async function cargar(){
  if(!qr_token){ alert("Token no especificado"); return; }
  try{
    const res = await fetch(`${API}/api/perfil/${qr_token}`);
    const data = await res.json();
    if(!res.ok || !data.conductor){ alert("Conductor no encontrado"); return; }
    const c = data.conductor;
    const docs = data.documentos || [];

    function docUrl(tipo){ const d = docs.find(x=>x.tipo===tipo); return d?d.url_archivo:null; }

    const contenido = document.getElementById("contenido");
    contenido.innerHTML = `
      <div><strong>Nombre:</strong> ${c.nombres} ${c.apellidos}</div>
      <div><strong>Cédula:</strong> ${c.cedula} ${docUrl("CEDULA")?`<a href="${docUrl("CEDULA")}" target="_blank">Ver</a>`:""}</div>
      <div><strong>Licencia:</strong> ${c.licencia} ${docUrl("LICENCIA")?`<a href="${docUrl("LICENCIA")}" target="_blank">Ver</a>`:""}</div>
      <div><strong>Vehículo:</strong> ${c.marca} ${c.modelo}</div>
      <div><strong>Placa:</strong> ${c.placa}</div>
      <div><strong>Color:</strong> ${c.color}</div>
      ${docUrl("FOTO_VEHICULO")?`<img src="${docUrl("FOTO_VEHICULO")}" style="max-width:100%">`:``}
      <div><strong>Póliza:</strong> ${c.poliza_numero} ${docUrl("POLIZA_VEHICULAR")?`<a href="${docUrl("POLIZA_VEHICULAR")}" target="_blank">Ver</a>`:""}</div>
      ${docUrl("FOTO_CONDUCTOR")?`<img src="${docUrl("FOTO_CONDUCTOR")}" style="max-width:100%">`:``}
    `;

    // Generar QR
    QRCode.toCanvas(document.getElementById("qr"), window.location.href,{ width:220,errorCorrectionLevel:'H' });

  } catch(err){ console.error(err); document.getElementById("contenido").innerText="Error al cargar perfil"; }
}

function descargarQR(){
  const canvas = document.getElementById("qr");
  const link = document.createElement("a");
  link.download = "perfil_qr.png";
  link.href = canvas.toDataURL();
  link.click();
}

cargar();
</script>
</body>
</html>