<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Perfil del Conductor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
    .card { background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); max-width:600px; margin:auto; }
    h2 { margin-top:0; text-align:center; }
    input, button { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; }
    button { background:#0d6efd; color:white; font-weight:bold; border:none; cursor:pointer; }
    button:hover { opacity:0.9; }
    img { max-width:100%; border-radius:8px; margin-top:10px; }
    label { font-weight:bold; margin-top:15px; display:block; }
    hr { margin:20px 0; }
    .section { margin-top:20px; }
    .queja { background:#fff3cd; padding:10px; border-radius:6px; margin-top:8px; }
  </style>
</head>
<body>

<div class="card">
  <h2>Perfil del Conductor</h2>

  <!-- LOGIN -->
  <div id="loginSection">
    <h3>Inicia sesi√≥n para editar tus datos</h3>
    <input id="loginEmail" type="email" placeholder="Correo electr√≥nico" required>
    <input id="loginPassword" type="password" placeholder="Contrase√±a" required>
    <button onclick="loginConductor()">Iniciar sesi√≥n</button>
    <div id="loginMensaje"></div>
  </div>

  <!-- PERFIL Y EDICI√ìN -->
  <div id="perfilSection" style="display:none;">
    <form id="formPerfil">
      <input id="nombres" placeholder="Nombres" required>
      <input id="apellidos" placeholder="Apellidos" required>
      <input id="cedula" placeholder="C√©dula" required>
      <input id="licencia" placeholder="N√∫mero de Licencia" required>
      <input id="placa" placeholder="N√∫mero de Placa Vehicular" required>
      <input id="poliza_numero" placeholder="N√∫mero de P√≥liza Vehicular" required>
      <input id="poliza_tipo" placeholder="Tipo de P√≥liza" required>
      <input id="celular" placeholder="N√∫mero de Celular" required>
      <input id="direccion" placeholder="Direcci√≥n" required>

      <hr>
      <label>Foto de Licencia</label>
      <input type="file" id="fileLicencia" accept="image/*,application/pdf">
      <label>Foto del Registro Vehicular</label>
      <input type="file" id="fileRegistro" accept="image/*,application/pdf">
      <label>Foto del Veh√≠culo</label>
      <input type="file" id="fileVehiculo" accept="image/*">
      <label>Paz y Salvo Municipal o Pago de Placa</label>
      <input type="file" id="filePazSalvo" accept="image/*,application/pdf">
      <label>Revisado Vehicular (Taller Autorizado)</label>
      <input type="file" id="fileRevisado" accept="image/*,application/pdf">

      <button type="submit">Actualizar datos</button>
    </form>

    <div class="section" id="documentosSection"></div>
    <div class="section" id="quejasSection"></div>
  </div>
</div>

<script>
const API = "https://conductores-api.onrender.com";

// ‚ö° Supabase client
const SUPABASE_URL = "https://ugchmuhjzzyofoogprlr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnY2htdWhqenp5b2Zvb2dwcmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODUyNDQsImV4cCI6MjA4NTY2MTI0NH0.kB4ZjPhfP29JL6apWFKrXfW-AwnsCKHfmVsBUVjPsX4";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let conductorId = new URLSearchParams(window.location.search).get("id");

// ==============================
// üîë LOGIN
// ==============================
async function loginConductor() {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const loginMensaje = document.getElementById("loginMensaje");

  loginMensaje.innerHTML = "Iniciando sesi√≥n...";

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) {
    loginMensaje.innerHTML = "Error: " + error.message;
    return;
  }

  currentUser = data.user;
  loginMensaje.innerHTML = "‚úÖ Sesi√≥n iniciada";
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("perfilSection").style.display = "block";

  cargarPerfil();
}

// ==============================
// üìÑ CARGAR PERFIL
// ==============================
async function cargarPerfil() {
  try {
    const res = await fetch(`${API}/api/conductores/${conductorId}`);
    const data = await res.json();

    if (!data.conductor) {
      alert("Conductor no encontrado");
      return;
    }

    const c = data.conductor;

    // Solo puede editar si es su usuario
    if(currentUser && c.auth_user_id !== currentUser.id){
      alert("No puedes editar este perfil");
      document.getElementById("perfilSection").style.display = "none";
      return;
    }

    // Rellenar campos
    document.getElementById("nombres").value = c.nombres;
    document.getElementById("apellidos").value = c.apellidos;
    document.getElementById("cedula").value = c.cedula;
    document.getElementById("licencia").value = c.licencia;
    document.getElementById("placa").value = c.placa;
    document.getElementById("poliza_numero").value = c.poliza_numero;
    document.getElementById("poliza_tipo").value = c.poliza_tipo;
    document.getElementById("celular").value = c.celular;
    document.getElementById("direccion").value = c.direccion;

    // Documentos
    const docSection = document.getElementById("documentosSection");
    docSection.innerHTML = "<h3>Documentos</h3>";
    if(data.documentos && data.documentos.length>0){
      data.documentos.forEach(doc => {
        docSection.innerHTML += `<p><strong>${doc.tipo}:</strong><br><a href="${doc.url_archivo}" target="_blank">Ver archivo</a></p>`;
      });
    }

    // Quejas
    const quejasSection = document.getElementById("quejasSection");
    quejasSection.innerHTML = "<h3>Historial de Reportes</h3>";
    if(data.quejas && data.quejas.length>0){
      data.quejas.forEach(q => {
        quejasSection.innerHTML += `<div class="queja">${q.descripcion}<br><small>${new Date(q.fecha).toLocaleDateString()}</small></div>`;
      });
    } else {
      quejasSection.innerHTML += "<p>Sin reportes registrados ‚úÖ</p>";
    }

  } catch(error){
    console.error(error);
  }
}

// ==============================
// üìù ACTUALIZAR PERFIL
// ==============================
document.getElementById("formPerfil").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const datos = {
    nombres: nombres.value,
    apellidos: apellidos.value,
    cedula: cedula.value,
    licencia: licencia.value,
    placa: placa.value,
    poliza_numero: poliza_numero.value,
    poliza_tipo: poliza_tipo.value,
    celular: celular.value,
    direccion: direccion.value
  };

  try{
    const res = await fetch(`${API}/api/conductores`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(datos)
    });
    const data = await res.json();
    if(!data.conductor) throw new Error("Error actualizando datos");

    // Subir documentos si hay
    async function subirDoc(tipo, inputId){
      const archivo = document.getElementById(inputId).files[0];
      if(!archivo) return;
      const fd = new FormData();
      fd.append("archivo", archivo);
      const upload = await fetch(`${API}/api/documentos/${conductorId}/${tipo}`, { method:"POST", body:fd });
      if(!upload.ok) throw new Error("Error subiendo " + tipo);
    }

    await subirDoc("licencia", "fileLicencia");
    await subirDoc("registro_vehicular", "fileRegistro");
    await subirDoc("foto_vehiculo", "fileVehiculo");
    await subirDoc("paz_y_salvo", "filePazSalvo");
    await subirDoc("revisado_vehicular", "fileRevisado");

    alert("Perfil actualizado ‚úÖ");
    cargarPerfil();

  }catch(err){
    console.error(err);
    alert("Error actualizando perfil ‚ùå");
  }
});
</script>

</body>
</html>
