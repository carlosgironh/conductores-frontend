<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Perfil del Conductor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f4f6f8; }
    .card { background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); max-width:600px; margin:auto; }
    h2 { margin-top:0; text-align:center; }
    input, button { width:100%; margin-top:10px; padding:10px; border-radius:6px; border:1px solid #ccc; }
    button { background:#0d6efd; color:white; font-weight:bold; border:none; cursor:pointer; }
    button:hover { opacity:0.9; }
    label { font-weight:bold; margin-top:15px; display:block; }
    hr { margin:20px 0; }
    .section { margin-top:20px; }
    .queja { background:#fff3cd; padding:10px; border-radius:6px; margin-top:8px; }
    #qrContainer { text-align:center; margin-top:20px; }
    #formPerfil input, #formPerfil button, #formPerfil label { display:none; }
    .resumen p { margin:5px 0; }
    .documento { background:#e7f3fe; padding:5px 10px; border-radius:6px; margin-top:5px; }
    .downloadQR { margin-top:10px; display:block; }
  </style>
</head>
<body>

<div class="card">
  <h2>Perfil del Conductor</h2>

  <!-- QR -->
  <div id="qrContainer">
    <p>Escanea el QR para acceder a este perfil:</p>
    <canvas id="qr"></canvas>
    <button class="downloadQR" onclick="descargarQR()">üì• Descargar QR</button>
  </div>

  <!-- LOGIN -->
  <div id="loginSection">
    <h3>Inicia sesi√≥n para editar tus datos</h3>
    <input id="loginEmail" type="email" placeholder="Correo electr√≥nico" required>
    <input id="loginPassword" type="password" placeholder="Contrase√±a" required>
    <button onclick="loginConductor()">Iniciar sesi√≥n</button>
    <div id="loginMensaje"></div>
  </div>

  <!-- PERFIL P√öBLICO -->
  <div id="perfilSection">
    <div class="resumen" id="resumenDatos"></div>

    <div class="section" id="quejasSection"></div>

    <!-- FORMULARIO DE EDICI√ìN OCULTO -->
    <form id="formPerfil">
      <input id="nombres" placeholder="Nombres">
      <input id="apellidos" placeholder="Apellidos">
      <input id="cedula" placeholder="C√©dula">
      <input id="licencia" placeholder="N√∫mero de Licencia">
      <input id="placa" placeholder="N√∫mero de Placa Vehicular">
      <input id="poliza_numero" placeholder="N√∫mero de P√≥liza Vehicular">
      <input id="poliza_tipo" placeholder="Tipo de P√≥liza">
      <input id="celular" placeholder="N√∫mero de Celular">
      <input id="direccion" placeholder="Direcci√≥n">

      <hr>
      <label>Foto de Licencia</label>
      <input type="file" id="fileLicencia" accept="image/*,application/pdf">
      <label>Foto del Registro Vehicular</label>
      <input type="file" id="fileRegistro" accept="image/*,application/pdf">
      <label>Foto del Veh√≠culo</label>
      <input type="file" id="fileVehiculo" accept="image/*">
      <label>Paz y Salvo Municipal o Pago de Placa</label>
      <input type="file" id="filePazSalvo" accept="image/*,application/pdf">
      <label>Revisado Vehicular (Taller Autorizado)</label>
      <input type="file" id="fileRevisado" accept="image/*,application/pdf">

      <button type="submit">Actualizar datos</button>
    </form>
  </div>
</div>

<script>
const API = "https://conductores-api.onrender.com";
const SUPABASE_URL = "https://ugchmuhjzzyofoogprlr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnY2htdWhqenp5b2Zvb2dwcmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODUyNDQsImV4cCI6MjA4NTY2MTI0NH0.kB4ZjPhfP29JL6apWFKrXfW-AwnsCKHfmVsBUVjPsX4";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let conductorId = new URLSearchParams(window.location.search).get("id");

// üîπ GENERAR QR
function generarQR() {
  const perfilURL = `${window.location.href}`;
  const canvas = document.getElementById("qr");
  QRCode.toCanvas(canvas, perfilURL, { width: 180 }, function (error) {
    if(error) console.error(error);
  });
}

// üîπ DESCARGAR QR
function descargarQR() {
  const canvas = document.getElementById("qr");
  const url = canvas.toDataURL("image/png");
  const link = document.createElement("a");
  link.href = url;
  link.download = "perfil_conductor.png";
  link.click();
}

// üîπ LOGIN
async function loginConductor() {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const loginMensaje = document.getElementById("loginMensaje");

  if(!email || !password){
    loginMensaje.innerHTML = "Ingrese email y contrase√±a";
    return;
  }

  loginMensaje.innerHTML = "Iniciando sesi√≥n...";

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) {
    loginMensaje.innerHTML = "Error: " + error.message;
    return;
  }

  currentUser = data.user;
  loginMensaje.innerHTML = "‚úÖ Sesi√≥n iniciada";

  habilitarEdicion();
}

// üîπ HABILITAR EDICI√ìN
function habilitarEdicion() {
  document.getElementById("formPerfil").querySelectorAll("input, button, label").forEach(el => el.style.display = "block");
  const resumen = document.getElementById("resumenDatos");
  resumen.querySelectorAll("p[data-campo]").forEach(p => {
    const id = p.dataset.campo;
    const input = document.getElementById(id);
    if(input) input.value = p.textContent.replace(`${p.dataset.label}: `,"");
  });
}

// üîπ CARGAR PERFIL P√öBLICO
async function cargarPerfil() {
  try {
    const res = await fetch(`${API}/api/conductores/${conductorId}`);
    const data = await res.json();

    if (!data.conductor) {
      alert("Conductor no encontrado");
      return;
    }

    const c = data.conductor;

    // Resumen p√∫blico de datos + documentos inline
    const resumen = document.getElementById("resumenDatos");
    resumen.innerHTML = `
      <p data-campo="nombres" data-label="Nombres">Nombres: ${c.nombres}</p>
      <p data-campo="apellidos" data-label="Apellidos">Apellidos: ${c.apellidos}</p>
      <p data-campo="cedula" data-label="C√©dula">C√©dula: ${c.cedula}</p>
      <p data-campo="licencia" data-label="Licencia">Licencia: ${c.licencia}</p>
      <p data-campo="placa" data-label="Placa">Placa: ${c.placa}</p>
      <p data-campo="poliza_numero" data-label="P√≥liza N¬∞">P√≥liza N¬∞: ${c.poliza_numero}</p>
      <p data-campo="poliza_tipo" data-label="Tipo P√≥liza">Tipo P√≥liza: ${c.poliza_tipo}</p>
      <p data-campo="celular" data-label="Celular">Celular: ${c.celular}</p>
      <p data-campo="direccion" data-label="Direcci√≥n">Direcci√≥n: ${c.direccion}</p>
    `;

    // Documentos inline
    if (data.documentos && data.documentos.length > 0) {
      data.documentos.forEach(doc => {
        const div = document.createElement("div");
        div.className = "documento";
        div.innerHTML = `<strong>${doc.tipo}:</strong><br>${doc.url_archivo}`;
        resumen.appendChild(div);
      });
    }

    // Quejas
    const quejasSection = document.getElementById("quejasSection");
    quejasSection.innerHTML = "<h3>Historial de Reportes</h3>";
    if (data.quejas && data.quejas.length > 0) {
      data.quejas.forEach(q => {
        quejasSection.innerHTML += `<div class="queja">${q.descripcion}<br><small>${new Date(q.fecha).toLocaleDateString()}</small></div>`;
      });
    } else {
      quejasSection.innerHTML += "<p>Sin reportes registrados ‚úÖ</p>";
    }

    // Generar QR
    generarQR();

  } catch (error) {
    console.error(error);
  }
}

// üîπ ACTUALIZAR PERFIL
document.getElementById("formPerfil").addEventListener("submit", async (e) => {
  e.preventDefault();

  if(!currentUser){
    alert("Debes iniciar sesi√≥n para editar tu perfil");
    return;
  }

  const datos = {};
  ["nombres","apellidos","cedula","licencia","placa","poliza_numero","poliza_tipo","celular","direccion"].forEach(id => {
    datos[id] = document.getElementById(id).value;
  });

  try{
    const res = await fetch(`${API}/api/conductores`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(datos)
    });
    const data = await res.json();
    if(!data.conductor) throw new Error("Error actualizando datos");

    // Subir documentos si hay
    async function subirDoc(tipo, inputId){
      const archivo = document.getElementById(inputId).files[0];
      if(!archivo) return;
      const fd = new FormData();
      fd.append("archivo", archivo);
      const upload = await fetch(`${API}/api/documentos/${conductorId}/${tipo}`, { method:"POST", body:fd });
      if(!upload.ok) throw new Error("Error subiendo " + tipo);
    }

    await subirDoc("licencia", "fileLicencia");
    await subirDoc("registro_vehicular", "fileRegistro");
    await subirDoc("foto_vehiculo", "fileVehiculo");
    await subirDoc("paz_y_salvo", "filePazSalvo");
    await subirDoc("revisado_vehicular", "fileRevisado");

    alert("Perfil actualizado ‚úÖ");
    cargarPerfil();

  }catch(err){
    console.error(err);
    alert("Error actualizando perfil ‚ùå");
  }
});

// Cargar perfil al inicio
cargarPerfil();

</script>
</body>
</html>
