<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Conductores</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:20px;
}

.card{
  max-width:720px;
  margin:auto;
  background:white;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,0.1);
  padding:25px;
}

h2{
  text-align:center;
  color:#0d6efd;
  margin-bottom:20px;
}

form input{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:8px;
  border:1px solid #ccc;
  box-sizing:border-box;
}

label{
  display:block;
  margin-top:15px;
  font-weight:bold;
}

button{
  background:#0d6efd;
  color:white;
  border:none;
  padding:12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin-top:20px;
  width:100%;
  font-size:16px;
}

#mensaje{
  margin-top:15px;
  font-weight:bold;
  text-align:center;
}

.error{ color:#b00020; }
.ok{ color:green; }
.busy{ color:#0b5ed7; }

.loader{
  border:3px solid #f3f3f3;
  border-top:3px solid white;
  border-radius:50%;
  width:14px;
  height:14px;
  animation: spin 1s linear infinite;
  display:inline-block;
  margin-right:8px;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<div class="card">
<h2>Registro de Conductores</h2>

<form id="formConductor">

<input id="email" type="email" placeholder="Correo" required>
<input id="password" type="password" placeholder="Contraseña" required minlength="6">

<hr>

<input id="nombres" type="text" placeholder="Nombres" required>
<input id="apellidos" type="text" placeholder="Apellidos" required>
<input id="cedula" type="text" placeholder="Cédula" required>
<input id="licencia" type="text" placeholder="Licencia" required>

<input id="placa" type="text" placeholder="Placa" required>
<input id="modelo" type="text" placeholder="Modelo" required>
<input id="marca" type="text" placeholder="Marca" required>
<input id="color" type="text" placeholder="Color" required>
<input id="poliza_numero" type="text" placeholder="Número de póliza" required>

<hr>

<label>Cédula</label>
<input type="file" id="fileCedula" required accept="image/*,application/pdf">

<label>Licencia</label>
<input type="file" id="fileLicencia" required accept="image/*,application/pdf">

<label>Registro Vehicular</label>
<input type="file" id="fileRegistro" required accept="image/*,application/pdf">

<label>Póliza</label>
<input type="file" id="filePoliza" required accept="image/*,application/pdf">

<label>Foto Vehículo</label>
<input type="file" id="fileFotoVehiculo" required accept="image/*">

<label>Foto Conductor</label>
<input type="file" id="fileFotoConductor" required accept="image/*">

<button type="submit" id="btnRegistrar">Registrar</button>
<div id="mensaje"></div>

</form>
</div>

<script>

const SUPABASE_URL = "https://ugchmuhjzzyofoogprlr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnY2htdWhqenp5b2Zvb2dwcmxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODUyNDQsImV4cCI6MjA4NTY2MTI0NH0.kB4ZjPhfP29JL6apWFKrXfW-AwnsCKHfmVsBUVjPsX4";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const form = document.getElementById("formConductor");
const btn = document.getElementById("btnRegistrar");
const mensaje = document.getElementById("mensaje");

function showMessage(text, type="") {
  mensaje.textContent = text;
  mensaje.className = type;
}

function validateFiles() {
  const MAX_SIZE = 5 * 1024 * 1024;
  const files = form.querySelectorAll("input[type='file']");
  for (let input of files) {
    const file = input.files[0];
    if (!file) throw new Error("Todos los documentos son obligatorios");
    if (file.size > MAX_SIZE) {
      throw new Error(`El archivo ${file.name} supera 5MB`);
    }
  }
}

async function uploadFile(userId, conductorId, tipo, inputId) {

  const file = document.getElementById(inputId).files[0];
  const filePath = `${conductorId}/${tipo}_${Date.now()}`;

  const { error: uploadError } =
    await supabase.storage
      .from("documentos-conductores")
      .upload(filePath, file);

  if (uploadError) throw uploadError;

  const { error: dbError } =
    await supabase.from("documentos")
      .insert([{
        conductor_id: conductorId,
        tipo,
        file_path: filePath
      }]);

  if (dbError) throw dbError;
}

form.addEventListener("submit", async (e) => {

  e.preventDefault();
  btn.disabled = true;
  btn.innerHTML = '<span class="loader"></span>Procesando...';
  showMessage("Creando registro...", "busy");

  try {

    validateFiles();

    const payload = {
      email: email.value.trim(),
      password: password.value,
      nombres: nombres.value.trim(),
      apellidos: apellidos.value.trim(),
      cedula: cedula.value.trim(),
      licencia: licencia.value.trim(),
      placa: placa.value.trim(),
      modelo: modelo.value.trim(),
      marca: marca.value.trim(),
      color: color.value.trim(),
      poliza_numero: poliza_numero.value.trim()
    };

    const response = await fetch(
      "https://ugchmuhjzzyofoogprlr.functions.supabase.co/registro",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    const data = await response.json();
    if (!response.ok) throw new Error(data.error);

    // LOGIN automático
    const { data: loginData, error: loginError } =
      await supabase.auth.signInWithPassword({
        email: payload.email,
        password: payload.password
      });

    if (loginError) throw loginError;

    const conductorId = data.conductorId;

    const documentos = [
      ["cedula","fileCedula"],
      ["licencia","fileLicencia"],
      ["registro_vehicular","fileRegistro"],
      ["poliza_vehicular","filePoliza"],
      ["foto_vehiculo","fileFotoVehiculo"],
      ["foto_conductor","fileFotoConductor"]
    ];

    for (const [tipo,id] of documentos) {
      await uploadFile(loginData.user.id, conductorId, tipo, id);
    }

    showMessage("Registro exitoso", "ok");
    form.reset();

  } catch (error) {
    console.error(error);
    showMessage(error.message, "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = "Registrar";
  }

});

</script>

</body>
</html>