<script>
document.addEventListener("DOMContentLoaded", () => {

const API = "https://conductores-api.onrender.com";
const form = document.getElementById("formConductor");
const btn = document.getElementById("btnRegistrar");
const mensaje = document.getElementById("mensaje");

function showMessage(text, type="") {
  mensaje.textContent = text;
  mensaje.className = type;
}

function validateFiles() {
  const MAX_SIZE = 5 * 1024 * 1024;
  const fileInputs = form.querySelectorAll("input[type='file']");
  for (let input of fileInputs) {
    const file = input.files[0];
    if (!file) throw new Error("Todos los documentos son obligatorios");
    if (file.size > MAX_SIZE) {
      throw new Error(`El archivo ${file.name} supera 5MB`);
    }
  }
}

async function login(email, password) {
  const res = await fetch(`${API}/api/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.error || "Error en login");
  return data.token;
}

async function uploadFile(conductorId, tipo, inputId, token) {
  const input = document.getElementById(inputId);
  const formData = new FormData();
  formData.append("archivo", input.files[0]);

  const res = await fetch(`${API}/api/documentos/${conductorId}/${tipo}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${token}`
    },
    body: formData
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.error || `Error subiendo ${tipo}`);
}

form.addEventListener("submit", async (e) => {

  e.preventDefault();
  if (btn.disabled) return;

  btn.disabled = true;
  btn.innerHTML = "Procesando...";
  showMessage("Creando registro...", "busy");

  try {

    validateFiles();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    const payload = {
      email,
      password,
      nombres: nombres.value.trim(),
      apellidos: apellidos.value.trim(),
      cedula: cedula.value.trim(),
      licencia: licencia.value.trim(),
      placa: placa.value.trim(),
      modelo: modelo.value.trim(),
      marca: marca.value.trim(),
      color: color.value.trim(),
      poliza_numero: poliza_numero.value.trim()
    };

    /* 1️⃣ Registrar */
    const resRegistro = await fetch(`${API}/api/registro`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const dataRegistro = await resRegistro.json();
    if (!resRegistro.ok) throw new Error(dataRegistro.error);

    const conductorId = dataRegistro.conductorId;

    /* 2️⃣ Login automático */
    const token = await login(email, password);

    /* 3️⃣ Subir documentos (tipos en minúsculas) */
    const documentos = [
      ["cedula","fileCedula"],
      ["licencia","fileLicencia"],
      ["registro_vehicular","fileRegistro"],
      ["poliza_vehicular","filePoliza"],
      ["foto_vehiculo","fileFotoVehiculo"],
      ["foto_conductor","fileFotoConductor"]
    ];

    for (const [tipo,id] of documentos) {
      await uploadFile(conductorId, tipo, id, token);
    }

    showMessage("Registro completo exitoso", "ok");
    form.reset();

  } catch (error) {
    showMessage(error.message, "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = "Registrar";
  }

});

});
</script>