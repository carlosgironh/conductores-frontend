<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Conductores</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Librer√≠a para generar QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}

h2 {
  border-bottom: 2px solid #ddd;
  padding-bottom: 5px;
}

input, button {
  display: block;
  margin: 8px 0;
  padding: 8px;
  width: 100%;
}

button {
  cursor: pointer;
  background: #1f6feb;
  color: white;
  border: none;
}

button:hover {
  background: #174ea6;
}

#qr {
  margin-top: 20px;
}

.hidden {
  display: none;
}
</style>
</head>

<body>

<h1>Sistema de Conductores üöó</h1>

<!-- ================= REGISTRO ================= -->
<h2>Registro</h2>

<input id="regEmail" placeholder="Email">
<input id="regPassword" type="password" placeholder="Password">

<input id="nombres" placeholder="Nombres">
<input id="apellidos" placeholder="Apellidos">
<input id="cedula" placeholder="C√©dula">
<input id="licencia" placeholder="Licencia">
<input id="placa" placeholder="Placa">
<input id="modelo" placeholder="Modelo">
<input id="marca" placeholder="Marca">
<input id="color" placeholder="Color">
<input id="poliza" placeholder="N√∫mero de p√≥liza">
<input id="celular" placeholder="Celular">
<input id="direccion" placeholder="Direcci√≥n">

<button onclick="registrar()">Registrar</button>

<div id="qr"></div>

<hr>

<!-- ================= LOGIN ================= -->
<h2>Login</h2>

<input id="loginEmail" placeholder="Email">
<input id="loginPassword" type="password" placeholder="Password">

<button onclick="login()">Iniciar Sesi√≥n</button>

<hr>

<!-- ================= SUBIR DOCUMENTOS ================= -->
<div id="documentosSection" class="hidden">
<h2>Subir Documentos</h2>

<input type="file" id="fileCedula">
<input type="file" id="fileLicencia">
<input type="file" id="fileRegistro">
<input type="file" id="filePoliza">
<input type="file" id="fileFotoVehiculo">
<input type="file" id="fileFotoConductor">

<button onclick="subirDocumentos()">Subir Documentos</button>
</div>

<script>

/* =====================================================
   ‚öô CONFIGURACI√ìN
===================================================== */

const API_URL = "http://localhost:3000";

let token = null;
let conductorId = null;

/* =====================================================
   üìù REGISTRO
===================================================== */

async function registrar() {

  const body = {
    email: regEmail.value,
    password: regPassword.value,
    nombres: nombres.value,
    apellidos: apellidos.value,
    cedula: cedula.value,
    licencia: licencia.value,
    placa: placa.value,
    modelo: modelo.value,
    marca: marca.value,
    color: color.value,
    poliza_numero: poliza.value,
    celular: celular.value,
    direccion: direccion.value
  };

  const res = await fetch(`${API_URL}/api/registro`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error);
    return;
  }

  conductorId = data.conductorId;

  /* Generar QR con token p√∫blico */
  const perfilURL = `${API_URL}/api/perfil/${data.qr_token}`;

  QRCode.toCanvas(perfilURL, function (err, canvas) {
    if (err) console.error(err);
    qr.innerHTML = "<h3>QR generado:</h3>";
    qr.appendChild(canvas);
  });

  alert("Registro exitoso");
}

/* =====================================================
   üîê LOGIN
===================================================== */

async function login() {

  const res = await fetch(`${API_URL}/api/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: loginEmail.value,
      password: loginPassword.value
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error);
    return;
  }

  token = data.token;

  /* Obtener conductorId desde perfil JWT */
  const user = parseJwt(token);
  conductorId = user.sub;

  documentosSection.classList.remove("hidden");

  alert("Login exitoso");
}

/* =====================================================
   üìÇ SUBIR DOCUMENTOS
===================================================== */

async function subirDocumentos() {

  const documentos = [
    ["cedula", fileCedula],
    ["licencia", fileLicencia],
    ["registro_vehicular", fileRegistro],
    ["poliza_vehicular", filePoliza],
    ["foto_vehiculo", fileFotoVehiculo],
    ["foto_conductor", fileFotoConductor]
  ];

  for (let [tipo, input] of documentos) {

    if (!input.files[0]) continue;

    const formData = new FormData();
    formData.append("archivo", input.files[0]);

    const res = await fetch(
      `${API_URL}/api/documentos/${conductorId}/${tipo}`,
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        },
        body: formData
      }
    );

    const data = await res.json();

    if (!res.ok) {
      alert(`Error en ${tipo}: ${data.error}`);
      return;
    }
  }

  alert("Todos los documentos fueron subidos correctamente");
}

/* =====================================================
   üß† DECODIFICAR JWT
===================================================== */

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));

  return JSON.parse(jsonPayload);
}

</script>

</body>
</html>