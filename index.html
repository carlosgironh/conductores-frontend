<script>
/* ==========================================================
   CONFIGURACIÃ“N GLOBAL
=========================================================== */
const API = "https://conductores-api.onrender.com";

/* ==========================================================
   REFERENCIAS DOM
=========================================================== */
const form = document.getElementById("formConductor");
const btn = document.getElementById("btnRegistrar");
const mensaje = document.getElementById("mensaje");

/* ==========================================================
   UTILIDAD: Mostrar mensajes visuales
=========================================================== */
function showMessage(text, type="") {
  mensaje.innerHTML = text;
  mensaje.className = type;
}

/* ==========================================================
   VALIDACIÃ“N: TamaÃ±o mÃ¡ximo de archivos (5MB)
=========================================================== */
function validateFiles() {
  const MAX_SIZE = 5 * 1024 * 1024;
  const fileInputs = form.querySelectorAll("input[type='file']");

  for (let input of fileInputs) {
    if (input.files[0] && input.files[0].size > MAX_SIZE) {
      throw new Error(`El archivo ${input.files[0].name} supera 5MB.`);
    }
  }
}

/* ==========================================================
   SUBIR DOCUMENTO CON JWT
=========================================================== */
async function uploadFile(conductorId, tipo, inputId, token) {

  const input = document.getElementById(inputId);
  if (!input.files.length) return;

  const formData = new FormData();
  formData.append("archivo", input.files[0]);

  // ðŸ” Normalizamos el tipo a minÃºscula por seguridad
  const tipoNormalizado = tipo.toLowerCase();

  const res = await fetch(`${API}/api/documentos/${conductorId}/${tipoNormalizado}`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`
    },
    body: formData
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `Error subiendo ${tipoNormalizado}`);
  }
}

/* ==========================================================
   EVENTO PRINCIPAL
=========================================================== */
form.addEventListener("submit", async (e) => {

  e.preventDefault();
  if (btn.disabled) return;

  btn.disabled = true;
  btn.innerHTML = '<span class="loader"></span>Procesando...';
  showMessage("Creando registro...", "busy");

  try {

    validateFiles();

    const payload = {
      email: email.value.trim(),
      password: password.value,
      nombres: nombres.value.trim(),
      apellidos: apellidos.value.trim(),
      cedula: cedula.value.trim(),
      licencia: licencia.value.trim(),
      placa: placa.value.trim(),
      modelo: modelo.value.trim(),
      marca: marca.value.trim(),
      color: color.value.trim(),
      poliza_numero: poliza_numero.value.trim()
    };

    /* ==============================
       1ï¸âƒ£ REGISTRO
    ============================== */
    const res = await fetch(`${API}/api/registro`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || "Error creando usuario");
    }

    const conductorId = data.conductorId;
    const qrToken = data.qr_token;

    if (!conductorId) {
      throw new Error("El servidor no devolviÃ³ conductorId");
    }

    /* ==============================
       2ï¸âƒ£ LOGIN AUTOMÃTICO
    ============================== */
    showMessage("Autenticando usuario...", "busy");

    const loginRes = await fetch(`${API}/api/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: payload.email,
        password: payload.password
      })
    });

    const loginData = await loginRes.json();

    if (!loginRes.ok) {
      throw new Error(loginData.error || "No se pudo autenticar usuario");
    }

    const userToken = loginData.token;

    if (!userToken) {
      throw new Error("No se recibiÃ³ token de autenticaciÃ³n");
    }

    localStorage.setItem("userToken", userToken);

    /* ==============================
       3ï¸âƒ£ SUBIR DOCUMENTOS
    ============================== */
    showMessage("Subiendo documentos...", "busy");

    // âœ… Tipos alineados con backend (minÃºsculas)
    const documentos = [
      ["cedula","fileCedula"],
      ["licencia","fileLicencia"],
      ["registro_vehicular","fileRegistro"],
      ["poliza_vehicular","filePoliza"],
      ["foto_vehiculo","fileFotoVehiculo"],
      ["foto_conductor","fileFotoConductor"]
    ];

    for (const [tipo,id] of documentos) {
      await uploadFile(conductorId, tipo, id, userToken);
    }

    /* ==============================
       4ï¸âƒ£ FINALIZACIÃ“N
    ============================== */
    showMessage("Â¡Registro exitoso! Redirigiendo...", "ok");
    form.reset();

    setTimeout(() => {
      window.location.href = `perfil.html?token=${qrToken}`;
    }, 1500);

  } catch (error) {

    console.error("Error registro:", error);
    showMessage("Error: " + error.message, "error");

  } finally {

    btn.disabled = false;
    btn.innerHTML = "Registrar";

  }

});
</script>